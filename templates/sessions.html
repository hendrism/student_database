{% extends "base.html" %}
{% block title %}Sessions{% endblock %}

{% block content %}
  <h2>Sessions</h2>

  <!-- Filter by date, student, and status -->
  <form method="GET" action="{{ url_for('routes.sessions') }}">
    <div class="form-row align-items-center mb-3">
      <div class="form-group mr-2">
        <label for="filter_date" class="sr-only">Date</label>
        <div class="input-group" style="max-width: 250px;">
          <input
            type="date"
            id="filter_date"
            name="filter_date"
            class="form-control"
            value="{{ filter_date or '' }}"
          >
          <div class="input-group-append">
            <button type="button" class="btn btn-secondary" onclick="setToday('filter_date')">
              Today
            </button>
          </div>
        </div>
      </div>
      <div class="form-group mr-2">
        <label for="filterStudent" class="sr-only">Student</label>
        <select id="filterStudent" name="filter_student" class="form-control">
          <option value="">All Students</option>
          {% for student in students %}
            <option value="{{ student.student_id }}" {% if filter_student == student.student_id|string %}selected{% endif %}>
              {{ student.first_name }} {{ student.last_name }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group mr-2">
        <label for="filterStatus" class="sr-only">Status</label>
        <select id="filterStatus" name="filter_status" class="form-control">
          <option value="">All Statuses</option>
          {% for status_option in ['Scheduled','Completed','Makeup Needed','Excused Absence'] %}
            <option value="{{ status_option }}" {% if filter_status == status_option %}selected{% endif %}>
              {{ status_option }}
            </option>
          {% endfor %}
        </select>
      </div>
      <button type="submit" class="btn btn-secondary">Filter</button>
      <a href="{{ url_for('routes.sessions') }}" class="btn btn-light">Clear</a>
    </div>
  </form>

  <!-- Launch calendar to add a new session/event -->
  <button
    class="btn btn-success mb-3"
    onclick="calendar.today(); $('#eventModal').modal('show');"
  >Add New Session</button>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Student(s)</th>
        <th>Date</th>
        <th>Time</th>
        <th>Status</th>
        <th>Plan Notes</th>
        <th>Objectives</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for ev in sessions %}
      <tr>
        <!-- STUDENT(S) COLUMN -->
        <td>{{ ev.student.first_name }} {{ ev.student.last_name }}</td>

        <!-- DATE/TIME -->
        <td>{{ ev.date_of_session.strftime('%Y-%m-%d') }}</td>
        <td>{{ ev.time_of_start.strftime('%H:%M') }} â€“ {{ ev.time_of_end.strftime('%H:%M') }}</td>

        <!-- STATUS (per student, paired correctly) -->
        <td>{{ ev.status }}</td>

        <!-- PLAN NOTES -->
        <td>{{ ev.plan_notes or 'N/A' }}</td>

        <!-- OBJECTIVES (per student, matched same way) -->
        <td>
          {% set objs = [] %}
          {% for goal in ev.student.goals if goal.active %}
            {% for obj in goal.objectives if obj.active %}
              {% set _ = objs.append(obj.objective_description ~ (obj.with_accuracy and ' ('~obj.with_accuracy~')' or '')) %}
            {% endfor %}
          {% endfor %}
          {% if objs %}
            <ul class="mb-0 pl-3">
              {% for desc in objs %}
                <li>{{ desc }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <em>No objectives</em>
          {% endif %}
        </td>

        <!-- ACTIONS -->
        <td>
          <!-- INLINE STATUS DROPDOWN -->
          <form class="ajax-form" method="POST"
                action="{{ url_for('routes.update_event', event_id=ev.event_id) }}"
                style="display:inline-block; margin-right:8px;">
            <select name="status" class="form-control form-control-sm status-select">
              {% for option in ['Scheduled','Completed','Makeup Needed','Excused Absence'] %}
                <option value="{{ option }}"
                        {% if ev.status == option %}selected{% endif %}>
                  {{ option }}
                </option>
              {% endfor %}
            </select>
          </form>

          <!-- ARCHIVE -->
          <form class="ajax-form" method="POST"
                action="{{ url_for('routes.archive_event', event_id=ev.event_id) }}"
                style="display:inline-block; margin-right:8px;"
                onsubmit="return confirmArchive();">
            <input type="hidden" name="next" value="{{ request.url }}">
            <button class="btn btn-secondary btn-sm">Archive</button>
          </form>

          <!-- DELETE -->
          <form class="ajax-form" method="POST"
                action="{{ url_for('routes.delete_event', event_id=ev.event_id) }}"
                style="display:inline-block;"
                onsubmit="return confirmDelete();">
            <input type="hidden" name="next" value="{{ request.url }}">
            <button class="btn btn-danger btn-sm">Delete</button>
          </form>

          <a href="{{ url_for('routes.student_sessions', student_id=ev.student.student_id) }}"
             class="btn btn-outline-info btn-sm mt-2" target="_blank">Recent Sessions</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endblock %}